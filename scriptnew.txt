<#
Exports SharePoint 2016 Nintex Display Forms to PDF using Edge + Selenium + DevTools.
- Auth: Windows prompt OK
- Works when launched from ISE or console
- Auto-downloads Selenium DLLs (or load from .\bin if offline)

Prereqs:
- msedgedriver.exe at: C:\Users\administrator.SAFALO\Desktop\Script\msedgedriver.exe
#>

param(
  [string]$WebUrl     = "https://sp.safalo.com/ConnorsWorkshop",
  [string]$ListName   = "OnboardingList",
  [int]   $StartID    = 1,
  [int]   $EndID      = 10,
  [string]$OutputPath = "C:\Exports\NintexForms",
  [switch]$Offline    # if set, don’t try to download Selenium DLLs; load from .\bin
)

# ---------- utilities ----------
# robust script root (works in ISE and console)
$ScriptRoot =
    if ($PSScriptRoot) { $PSScriptRoot }
    elseif ($PSCommandPath) { Split-Path -Parent $PSCommandPath }
    else { (Get-Location).Path }

function Ensure-Folder([string]$p) {
  if (-not [string]::IsNullOrWhiteSpace($p) -and -not (Test-Path $p)) {
    New-Item -ItemType Directory -Path $p -Force | Out-Null
  }
}

# ensure we can download from NuGet (older Windows defaults)
try { [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12 } catch {}

function Ensure-SeleniumAssemblies {
  $bin = Join-Path $ScriptRoot "bin"
  Ensure-Folder $bin

  $wd  = Join-Path $bin "WebDriver.dll"
  $sup = Join-Path $bin "WebDriver.Support.dll"

  if (-not (Test-Path $wd -PathType Leaf) -or -not (Test-Path $sup -PathType Leaf)) {
    if ($Offline) {
      throw "Selenium DLLs not found in `"$bin`" and -Offline was specified. Place WebDriver.dll and WebDriver.Support.dll there."
    }

    Write-Host "Downloading Selenium assemblies to $bin ..." -ForegroundColor Yellow
    Add-Type -AssemblyName System.IO.Compression.FileSystem

    $packages = @{
      "selenium.webdriver.4.22.0.nupkg" = "https://globalcdn.nuget.org/packages/selenium.webdriver.4.22.0.nupkg"
      "selenium.support.4.22.0.nupkg"   = "https://globalcdn.nuget.org/packages/selenium.support.4.22.0.nupkg"
    }

    foreach ($kv in $packages.GetEnumerator()) {
      $nupkgPath = Join-Path $bin $kv.Key
      if (-not (Test-Path $nupkgPath)) {
        Invoke-WebRequest -Uri $kv.Value -OutFile $nupkgPath
      }
      $zip = [IO.Compression.ZipFile]::OpenRead($nupkgPath)
      foreach ($entry in $zip.Entries) {
        if ($entry.FullName -like "lib/net48/*.dll") {
          $out = Join-Path $bin ([IO.Path]::GetFileName($entry.FullName))
          $fs = [IO.File]::Open($out, [IO.FileMode]::Create)
          $entry.Open().CopyTo($fs)
          $fs.Dispose()
        }
      }
      $zip.Dispose()
    }
  }

  Add-Type -Path $wd -ErrorAction Stop
  Add-Type -Path $sup -ErrorAction Stop
}

function Wait-ForNintexRender($driver, [int]$timeoutSec = 45) {
  try {
    $wait = New-Object OpenQA.Selenium.Support.UI.WebDriverWait($driver, [TimeSpan]::FromSeconds($timeoutSec))
    $null = $wait.Until({
      param($d)
      try {
        $ready = $d.ExecuteScript("return document.readyState") -eq "complete"
        $els = $d.FindElements([OpenQA.Selenium.By]::CssSelector("div.nf-form,div#formFiller,div.ms-formtable"))
        return ($ready -and $els.Count -gt 0)
      } catch { $false }
    })
    return $true
  } catch { return $false }
}

function Save-PdfFromDevTools($driver, [string]$path) {
  $args = @{
    "printBackground"   = $true
    "landscape"         = $false
    "scale"             = 1.0
    "marginTop"         = 0.4
    "marginBottom"      = 0.4
    "marginLeft"        = 0.4
    "marginRight"       = 0.4
    "preferCSSPageSize" = $true
    "paperWidth"        = 8.5
    "paperHeight"       = 11.0
  }
  $resp = $driver.ExecuteCdpCommand("Page.printToPDF", $args)
  [IO.File]::WriteAllBytes($path, [Convert]::FromBase64String($resp["data"])) | Out-Null
}
# ---------- /utilities ----------

Write-Host "Edge + Selenium + DevTools PDF export" -ForegroundColor Cyan
Write-Host "Site : $WebUrl"  -ForegroundColor Gray
Write-Host "List : $ListName  IDs: $StartID..$EndID" -ForegroundColor Gray

Ensure-Folder $OutputPath
Ensure-SeleniumAssemblies

# Path to EdgeDriver
$driverPath = 'C:\Users\administrator.SAFALO\Desktop\Script\msedgedriver.exe'
$driverDir  = Split-Path $driverPath -Parent
$driverName = Split-Path $driverPath -Leaf

# Start EdgeDriver service explicitly
$edgeSvc = [OpenQA.Selenium.Edge.EdgeDriverService]::CreateDefaultService($driverDir, $driverName)
$edgeSvc.HideCommandPromptWindow = $true

# Edge options
$opts = New-Object OpenQA.Selenium.Edge.EdgeOptions
$opts.UseChromium = $true

$host = ([Uri]$WebUrl).Host
$opts.AddArgument("--auth-server-allowlist=$host")
$opts.AddArgument("--auth-negotiate-delegate-whitelist=$host")
$opts.AddArgument("--disable-features=BlockInsecurePrivateNetworkRequests")
$opts.AddArgument("--headless=new")     # remove this line if you prefer a visible window
$opts.AddArgument("--disable-gpu")

# Launch Edge
$driver = New-Object OpenQA.Selenium.Edge.EdgeDriver($edgeSvc, $opts)
$driver.Manage().Timeouts().PageLoad = [TimeSpan]::FromSeconds(180)

$ok = 0; $bad = 0

try {
  for ($id = $StartID; $id -le $EndID; $id++) {
    $url = "$WebUrl/Lists/$ListName/DispForm.aspx?ID=$id"
    $out = Join-Path $OutputPath ("NintexForm_ID{0}.pdf" -f $id)
    Write-Host "ID $id → $url" -ForegroundColor White
    try {
      $driver.Navigate().GoToUrl($url) | Out-Null

      if (-not (Wait-ForNintexRender $driver 60)) {
        Write-Host "  (Warning) Form may not be fully rendered; proceeding..." -ForegroundColor Yellow
      }

      Save-PdfFromDevTools -driver $driver -path $out

      if (Test-Path $out) {
        $bytes = (Get-Item $out).Length
        Write-Host ("  Saved {0:N0} bytes → {1}" -f $bytes, $out) -ForegroundColor Green
        $ok++
      } else {
        throw "No file produced."
      }
    }
    catch {
      Write-Host ("  FAILED: {0}" -f $_.Exception.Message) -ForegroundColor Red
      $bad++
    }
    Start-Sleep -Milliseconds 300
  }
}
finally {
  if ($driver) { $driver.Quit() }
}

Write-Host "`n=== RESULTS ===" -ForegroundColor Cyan
Write-Host ("Successful: {0}" -f $ok) -ForegroundColor Green
Write-Host ("Failed    : {0}" -f $bad) -ForegroundColor Red
Write-Host ("Output    : {0}" -f $OutputPath) -ForegroundColor Gray
