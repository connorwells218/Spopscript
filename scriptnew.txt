<#
Exports SharePoint 2016 (on-prem) Nintex Display Forms to PDF
- Auth: Windows Integrated (popup prompt is fine)
- Browser: Microsoft Edge (Chromium) + msedgedriver.exe
- PDF: DevTools Page.printToPDF (saves directly, no dialogs)

Make sure:
- msedgedriver.exe is at C:\Users\administrator.SAFALO\Desktop\Script\msedgedriver.exe
- Run this script as a domain user who can open the list items
- Selenium DLLs (WebDriver.dll + WebDriver.Support.dll) are loaded (see Ensure-SeleniumAssemblies)
#>

param(
  [string]$WebUrl     = "https://sp.safalo.com/ConnorsWorkshop",
  [string]$ListName   = "OnboardingList",
  [int]   $StartID    = 1,
  [int]   $EndID      = 10,
  [string]$OutputPath = "C:\Exports\NintexForms"
)

# -------------------- helpers --------------------
function Ensure-Folder([string]$p) {
  if (-not (Test-Path $p)) { New-Item -ItemType Directory -Path $p -Force | Out-Null }
}

function Get-ScriptDir {
  Split-Path -Parent $MyInvocation.MyCommand.Path
}

function Ensure-SeleniumAssemblies {
  $root = Get-ScriptDir
  $bin  = Join-Path $root "bin"
  Ensure-Folder $bin

  $need = @(
    "WebDriver.dll",
    "WebDriver.Support.dll"
  )

  $dllsPresent = $true
  foreach ($f in $need) {
    if (-not (Test-Path (Join-Path $bin $f))) { $dllsPresent = $false }
  }

  if (-not $dllsPresent) {
    Write-Host "Downloading Selenium assemblies..." -ForegroundColor Yellow
    Add-Type -AssemblyName System.IO.Compression.FileSystem

    $pkgs = @{
      "Selenium.WebDriver.4.22.0.nupkg" = "https://globalcdn.nuget.org/packages/selenium.webdriver.4.22.0.nupkg"
      "Selenium.Support.4.22.0.nupkg"   = "https://globalcdn.nuget.org/packages/selenium.support.4.22.0.nupkg"
    }

    foreach ($kv in $pkgs.GetEnumerator()) {
      $dest = Join-Path $bin $kv.Key
      if (-not (Test-Path $dest)) {
        Invoke-WebRequest -Uri $kv.Value -OutFile $dest
      }
      $zip = [IO.Compression.ZipFile]::OpenRead($dest)
      foreach ($entry in $zip.Entries) {
        if ($entry.FullName -like "lib/net48/*.dll") {
          $out = Join-Path $bin ([IO.Path]::GetFileName($entry.FullName))
          $fs = [IO.File]::Open($out, [IO.FileMode]::Create)
          $entry.Open().CopyTo($fs)
          $fs.Dispose()
        }
      }
      $zip.Dispose()
    }
  }

  Add-Type -Path (Join-Path $bin "WebDriver.dll")        -ErrorAction Stop
  Add-Type -Path (Join-Path $bin "WebDriver.Support.dll") -ErrorAction Stop
}

function Wait-ForNintexRender($driver, [int]$timeoutSec = 45) {
  try {
    $wait = New-Object OpenQA.Selenium.Support.UI.WebDriverWait($driver, [TimeSpan]::FromSeconds($timeoutSec))
    $null = $wait.Until({
      param($d)
      try {
        $ready = $d.ExecuteScript("return document.readyState") -eq "complete"
        $els = $d.FindElements([OpenQA.Selenium.By]::CssSelector("div.nf-form,div#formFiller,div.ms-formtable"))
        return ($ready -and $els.Count -gt 0)
      } catch { $false }
    })
    return $true
  } catch { return $false }
}

function Save-PdfFromDevTools($driver, [string]$path) {
  $args = @{
    "printBackground"   = $true
    "landscape"         = $false
    "scale"             = 1.0
    "marginTop"         = 0.4
    "marginBottom"      = 0.4
    "marginLeft"        = 0.4
    "marginRight"       = 0.4
    "preferCSSPageSize" = $true
    "paperWidth"        = 8.5   # Letter size
    "paperHeight"       = 11.0
  }
  $resp = $driver.ExecuteCdpCommand("Page.printToPDF", $args)
  $b64  = $resp["data"]
  [IO.File]::WriteAllBytes($path, [Convert]::FromBase64String($b64)) | Out-Null
}
# -------------------- /helpers --------------------

Write-Host "Edge + Selenium + DevTools PDF export" -ForegroundColor Cyan
Write-Host "Site : $WebUrl"  -ForegroundColor Gray
Write-Host "List : $ListName  IDs: $StartID..$EndID" -ForegroundColor Gray

Ensure-Folder $OutputPath
Ensure-SeleniumAssemblies

# Path to msedgedriver.exe
$driverPath = 'C:\Users\administrator.SAFALO\Desktop\Script\msedgedriver.exe'
$driverDir  = Split-Path $driverPath -Parent
$driverName = Split-Path $driverPath -Leaf

# Start EdgeDriver service explicitly
$edgeSvc = [OpenQA.Selenium.Edge.EdgeDriverService]::CreateDefaultService($driverDir, $driverName)
$edgeSvc.HideCommandPromptWindow = $true

$opts = New-Object OpenQA.Selenium.Edge.EdgeOptions
$opts.UseChromium = $true
$opts.AddArgument("--auth-server-allowlist=" + ([Uri]$WebUrl).Host)
$opts.AddArgument("--auth-negotiate-delegate-whitelist=" + ([Uri]$WebUrl).Host)
$opts.AddArgument("--disable-features=BlockInsecurePrivateNetworkRequests")
$opts.AddArgument("--headless=new")    # remove if you want a visible browser
$opts.AddArgument("--disable-gpu")

$driver = New-Object OpenQA.Selenium.Edge.EdgeDriver($edgeSvc, $opts)
$driver.Manage().Timeouts().PageLoad = [TimeSpan]::FromSeconds(180)

$ok = 0; $bad = 0

try {
  for ($id = $StartID; $id -le $EndID; $id++) {
    $url = "$WebUrl/Lists/$ListName/DispForm.aspx?ID=$id"
    $out = Join-Path $OutputPath ("NintexForm_ID{0}.pdf" -f $id)
    Write-Host "ID $id → $url" -ForegroundColor White
    try {
      $driver.Navigate().GoToUrl($url) | Out-Null
      if (-not (Wait-ForNintexRender $driver 60)) {
        Write-Host "  (Warning) Form may not be fully rendered; proceeding..." -ForegroundColor Yellow
      }
      Save-PdfFromDevTools -driver $driver -path $out
      if (Test-Path $out) {
        $bytes = (Get-Item $out).Length
        Write-Host ("  Saved {0:N0} bytes → {1}" -f $bytes, $out) -ForegroundColor Green
        $ok++
      } else {
        throw "No file produced."
      }
    }
    catch {
      Write-Host ("  FAILED: {0}" -f $_.Exception.Message) -ForegroundColor Red
      $bad++
    }
    Start-Sleep -Milliseconds 300
  }
}
finally {
  $driver.Quit()
}

Write-Host "`n=== RESULTS ===" -ForegroundColor Cyan
Write-Host ("Successful: {0}" -f $ok) -ForegroundColor Green
Write-Host ("Failed    : {0}" -f $bad) -ForegroundColor Red
Write-Host ("Output    : {0}" -f $OutputPath) -ForegroundColor Gray
